<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWAæµ‹è¯• - çŒ«å¤´é¹°é‚®ä¿¡çŸ­ä¿¡ç¾¤å‘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { background: #dcfce7; color: #166534; }
        .error { background: #fef2f2; color: #dc2626; }
        .warning { background: #fef3c7; color: #d97706; }
        .info { background: #dbeafe; color: #1d4ed8; }
        button {
            background: #f97316;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #ea580c;
        }
        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .icon-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .icon-item {
            text-align: center;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .icon-item img {
            display: block;
            margin: 0 auto 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¦‰ PWAåŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-card">
        <h2>ğŸ“± PWAåŸºç¡€æ£€æµ‹</h2>
        <div id="pwa-support"></div>
        <div id="manifest-status"></div>
        <div id="sw-status"></div>
    </div>

    <div class="test-card">
        <h2>ğŸ¯ å›¾æ ‡æ£€æµ‹</h2>
        <p>æ£€æŸ¥æ‰€æœ‰å°ºå¯¸çš„åº”ç”¨å›¾æ ‡æ˜¯å¦æ­£ç¡®åŠ è½½ï¼š</p>
        <div class="icon-preview" id="icon-preview">
            <!-- å›¾æ ‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <button onclick="testIcons()">æ£€æµ‹å›¾æ ‡</button>
    </div>

    <div class="test-card">
        <h2>âš™ï¸ Service Worker çŠ¶æ€</h2>
        <div id="sw-details"></div>
        <button onclick="testServiceWorker()">æµ‹è¯•Service Worker</button>
        <button onclick="testOffline()">æµ‹è¯•ç¦»çº¿åŠŸèƒ½</button>
    </div>

    <div class="test-card">
        <h2>ğŸ“² å®‰è£…åŠŸèƒ½</h2>
        <div id="install-status"></div>
        <button id="install-btn" onclick="installPWA()" disabled>å®‰è£…åˆ°æ¡Œé¢</button>
        <button onclick="testInstallPrompt()">æ£€æµ‹å®‰è£…æç¤º</button>
    </div>

    <div class="test-card">
        <h2>ğŸ”” æ¨é€é€šçŸ¥</h2>
        <div id="notification-status"></div>
        <button onclick="testNotifications()">æµ‹è¯•é€šçŸ¥æƒé™</button>
        <button onclick="sendTestNotification()">å‘é€æµ‹è¯•é€šçŸ¥</button>
    </div>

    <div class="test-card">
        <h2>ğŸ’¾ ç¦»çº¿å­˜å‚¨</h2>
        <div id="storage-status"></div>
        <button onclick="testLocalStorage()">æµ‹è¯•æœ¬åœ°å­˜å‚¨</button>
        <button onclick="testIndexedDB()">æµ‹è¯•IndexedDB</button>
    </div>

    <script>
        let deferredPrompt;

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œåˆå§‹æ£€æµ‹
        window.addEventListener('load', () => {
            checkPWASupport();
            checkManifest();
            checkServiceWorker();
            checkInstallability();
        });

        // PWAæ”¯æŒæ£€æµ‹
        function checkPWASupport() {
            const statusDiv = document.getElementById('pwa-support');

            if ('serviceWorker' in navigator && 'PushManager' in window) {
                statusDiv.innerHTML = '<div class="status success">âœ… æµè§ˆå™¨æ”¯æŒPWAåŠŸèƒ½</div>';
            } else {
                statusDiv.innerHTML = '<div class="status error">âŒ æµè§ˆå™¨ä¸å®Œå…¨æ”¯æŒPWAåŠŸèƒ½</div>';
            }
        }

        // Manifestæ£€æµ‹
        function checkManifest() {
            const statusDiv = document.getElementById('manifest-status');

            fetch('/manifest.json')
                .then(response => response.json())
                .then(manifest => {
                    statusDiv.innerHTML = `
                        <div class="status success">âœ… ManifeståŠ è½½æˆåŠŸ</div>
                        <div class="status info">åº”ç”¨åç§°: ${manifest.name}</div>
                        <div class="status info">ä¸»é¢˜é¢œè‰²: ${manifest.theme_color}</div>
                        <div class="status info">å›¾æ ‡æ•°é‡: ${manifest.icons.length}</div>
                    `;
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="status error">âŒ ManifeståŠ è½½å¤±è´¥</div>';
                });
        }

        // Service Workeræ£€æµ‹
        function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            statusDiv.innerHTML = `
                                <div class="status success">âœ… Service Workerå·²æ³¨å†Œ</div>
                                <div class="status info">ä½œç”¨åŸŸ: ${registration.scope}</div>
                            `;
                        } else {
                            statusDiv.innerHTML = '<div class="status warning">âš ï¸ Service Workeræœªæ³¨å†Œ</div>';
                        }
                    });
            } else {
                statusDiv.innerHTML = '<div class="status error">âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker</div>';
            }
        }

        // å›¾æ ‡æµ‹è¯•
        function testIcons() {
            const preview = document.getElementById('icon-preview');
            const sizes = [72, 96, 128, 144, 152, 192, 384, 512];

            preview.innerHTML = '';

            sizes.forEach(size => {
                const iconItem = document.createElement('div');
                iconItem.className = 'icon-item';

                const img = document.createElement('img');
                img.src = `icons/icon-${size}x${size}.png`;
                img.width = Math.min(size, 64);
                img.height = Math.min(size, 64);
                img.alt = `${size}x${size}`;

                img.onload = () => {
                    iconItem.innerHTML = `
                        <img src="${img.src}" width="${img.width}" height="${img.height}" alt="${img.alt}">
                        <small style="color: green;">${size}x${size} âœ“</small>
                    `;
                };

                img.onerror = () => {
                    iconItem.innerHTML = `
                        <div style="width: ${Math.min(size, 64)}px; height: ${Math.min(size, 64)}px; background: #f3f4f6; border: 1px dashed #d1d5db; display: flex; align-items: center; justify-content: center;">âŒ</div>
                        <small style="color: red;">${size}x${size} âœ—</small>
                    `;
                };

                iconItem.appendChild(img);
                preview.appendChild(iconItem);
            });
        }

        // Service Workerè¯¦ç»†æµ‹è¯•
        function testServiceWorker() {
            const statusDiv = document.getElementById('sw-details');

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    statusDiv.innerHTML = `
                        <div class="status success">âœ… Service Workerå°±ç»ª</div>
                        <div class="status info">çŠ¶æ€: ${registration.active.state}</div>
                        <div class="status info">è„šæœ¬URL: ${registration.active.scriptURL}</div>
                    `;
                });
            }
        }

        // ç¦»çº¿åŠŸèƒ½æµ‹è¯•
        function testOffline() {
            const statusDiv = document.getElementById('sw-details');

            // æµ‹è¯•ç¼“å­˜
            caches.has('sms-messenger-v1.0.0').then(hasCache => {
                if (hasCache) {
                    caches.open('sms-messenger-v1.0.0').then(cache => {
                        cache.keys().then(requests => {
                            statusDiv.innerHTML += `
                                <div class="status success">âœ… ç¼“å­˜å­˜åœ¨</div>
                                <div class="status info">ç¼“å­˜æ–‡ä»¶æ•°é‡: ${requests.length}</div>
                            `;
                        });
                    });
                } else {
                    statusDiv.innerHTML += '<div class="status warning">âš ï¸ ç¼“å­˜ä¸å­˜åœ¨</div>';
                }
            });
        }

        // å®‰è£…æç¤ºæ£€æµ‹
        function checkInstallability() {
            const statusDiv = document.getElementById('install-status');
            const installBtn = document.getElementById('install-btn');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.disabled = false;
                statusDiv.innerHTML = '<div class="status success">âœ… åº”ç”¨å¯ä»¥å®‰è£…</div>';
            });

            window.addEventListener('appinstalled', (evt) => {
                statusDiv.innerHTML += '<div class="status success">ğŸ‰ åº”ç”¨å·²å®‰è£…</div>';
                deferredPrompt = null;
                installBtn.disabled = true;
            });
        }

        // å®‰è£…PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('install-status').innerHTML +=
                            '<div class="status success">âœ… ç”¨æˆ·æ¥å—äº†å®‰è£…</div>';
                    } else {
                        document.getElementById('install-status').innerHTML +=
                            '<div class="status warning">âš ï¸ ç”¨æˆ·æ‹’ç»äº†å®‰è£…</div>';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // æµ‹è¯•å®‰è£…æç¤º
        function testInstallPrompt() {
            const statusDiv = document.getElementById('install-status');

            if (window.matchMedia('(display-mode: standalone)').matches) {
                statusDiv.innerHTML = '<div class="status success">âœ… å½“å‰è¿è¡Œåœ¨ç‹¬ç«‹æ¨¡å¼ï¼ˆå·²å®‰è£…ï¼‰</div>';
            } else {
                statusDiv.innerHTML = '<div class="status info">â„¹ï¸ å½“å‰è¿è¡Œåœ¨æµè§ˆå™¨æ¨¡å¼</div>';
            }
        }

        // é€šçŸ¥æµ‹è¯•
        function testNotifications() {
            const statusDiv = document.getElementById('notification-status');

            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    statusDiv.innerHTML = '<div class="status success">âœ… é€šçŸ¥æƒé™å·²æˆäºˆ</div>';
                } else if (Notification.permission === 'denied') {
                    statusDiv.innerHTML = '<div class="status error">âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»</div>';
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            statusDiv.innerHTML = '<div class="status success">âœ… é€šçŸ¥æƒé™å·²æˆäºˆ</div>';
                        } else {
                            statusDiv.innerHTML = '<div class="status error">âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»</div>';
                        }
                    });
                }
            } else {
                statusDiv.innerHTML = '<div class="status error">âŒ æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥</div>';
            }
        }

        // å‘é€æµ‹è¯•é€šçŸ¥
        function sendTestNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('PWAæµ‹è¯•é€šçŸ¥', {
                    body: 'è¿™æ˜¯ä¸€æ¡æ¥è‡ªçŒ«å¤´é¹°é‚®ä¿¡çš„æµ‹è¯•é€šçŸ¥',
                    icon: '/icons/icon-192x192.png',
                    badge: '/icons/icon-72x72.png'
                });

                document.getElementById('notification-status').innerHTML +=
                    '<div class="status success">âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€</div>';
            } else {
                document.getElementById('notification-status').innerHTML +=
                    '<div class="status error">âŒ æ— æ³•å‘é€é€šçŸ¥</div>';
            }
        }

        // æœ¬åœ°å­˜å‚¨æµ‹è¯•
        function testLocalStorage() {
            const statusDiv = document.getElementById('storage-status');

            try {
                localStorage.setItem('pwa-test', 'success');
                const result = localStorage.getItem('pwa-test');
                localStorage.removeItem('pwa-test');

                if (result === 'success') {
                    statusDiv.innerHTML = '<div class="status success">âœ… LocalStorageå·¥ä½œæ­£å¸¸</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">âŒ LocalStorageå¼‚å¸¸</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">âŒ LocalStorageä¸å¯ç”¨</div>';
            }
        }

        // IndexedDBæµ‹è¯•
        function testIndexedDB() {
            const statusDiv = document.getElementById('storage-status');

            if ('indexedDB' in window) {
                const request = indexedDB.open('PWATest', 1);

                request.onsuccess = () => {
                    statusDiv.innerHTML += '<div class="status success">âœ… IndexedDBå·¥ä½œæ­£å¸¸</div>';
                    request.result.close();
                };

                request.onerror = () => {
                    statusDiv.innerHTML += '<div class="status error">âŒ IndexedDBè¿æ¥å¤±è´¥</div>';
                };
            } else {
                statusDiv.innerHTML += '<div class="status error">âŒ IndexedDBä¸æ”¯æŒ</div>';
            }
        }
    </script>
</body>
</html>